---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { labelFromSlug, normalizeMeta, resolveSummary } from "../../utils/briefs";

export async function getStaticPaths() {
  const briefs = await getCollection("signals");
  const sectorMap = new Map<string, string>();

  briefs.forEach((brief) => {
    const rawLabel = brief.data.sector?.trim();
    const slug = normalizeMeta(rawLabel);
    if (!slug || sectorMap.has(slug)) return;
    sectorMap.set(slug, rawLabel || labelFromSlug(slug));
  });

  return Array.from(sectorMap.entries()).map(([slug, label]) => ({
    params: { sector: slug },
    props: { sector: { slug, label } },
  }));
}

const { sector } = Astro.props as { sector: { slug: string; label: string } };

const dateFormatter = new Intl.DateTimeFormat("en-US", {
  year: "numeric",
  month: "short",
  day: "2-digit",
});

const sectorBriefs = (await getCollection("signals"))
  .filter((brief) => normalizeMeta(brief.data.sector) === sector.slug)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
---

<BaseLayout title={`${sector.label} | Sectors | AI Coachella Valley`}>
  <h1>{sector.label}</h1>
  <p>Latest briefs and evidence for the {sector.label} sector.</p>

  <section>
    <h2>Latest Briefs</h2>
    {sectorBriefs.length === 0 ? (
      <p>No briefs for this sector yet.</p>
    ) : (
      <ul class="brief-list">
        {sectorBriefs.map((brief) => (
          <li>
            <h3><a href={`/briefs/${brief.slug}`}>{brief.data.title}</a></h3>
            <p class="meta">{dateFormatter.format(brief.data.date)}</p>
            <p>{resolveSummary(brief)}</p>
          </li>
        ))}
      </ul>
    )}
  </section>

  <section>
    <h2>Actions</h2>
    <div class="cta-row">
      <a href={`/submit?sector=${sector.slug}`}>Submit a brief</a>
      <a href="/tools/aio">AIO tool</a>
      <a href="/events">Events</a>
      <a href="/cities">Cities</a>
    </div>
  </section>

  <p>
    <a href="/sectors">All Sectors</a>
    <span aria-hidden="true"> | </span>
    <a href="/briefs">Briefs</a>
  </p>
</BaseLayout>

<style>
  section + section {
    margin-top: 2rem;
  }

  .brief-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 0.75rem;
  }

  .brief-list li {
    border: 1px solid #d8dbe1;
    background: #fff;
    padding: 0.9rem 1rem;
  }

  .brief-list h3 {
    margin: 0;
    font-size: 1.05rem;
  }

  .brief-list a {
    color: #184a9c;
    text-decoration: none;
  }

  .brief-list a:hover,
  .brief-list a:focus-visible {
    text-decoration: underline;
  }

  .meta {
    color: #4b5360;
    font-size: 0.92rem;
    margin: 0.35rem 0 0;
  }

  .brief-list p {
    margin: 0.35rem 0 0;
  }

  .cta-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .cta-row a {
    border: 1px solid #c8ced8;
    background: #fff;
    border-radius: 999px;
    padding: 0.35rem 0.8rem;
    color: #184a9c;
    text-decoration: none;
    font-weight: 600;
  }

  .cta-row a:hover,
  .cta-row a:focus-visible {
    text-decoration: underline;
  }
</style>
