---
import BaseLayout from "../../../../layouts/BaseLayout.astro";
---

<BaseLayout title="AI Visibility Checkup Share | AI Coachella Valley">
  <section class="share-wrap">
    <article class="card">
      <p class="small">Generated by AI Coachella Valley (AICV)</p>
      <h1>AI Visibility Checkup</h1>
      <p id="share-meta" class="small">Loading shared result...</p>
      <p id="score" class="score">-</p>
      <p id="grade" class="pill">-</p>
      <p id="confidence" class="small"></p>
    </article>

    <article class="card">
      <h2>Top fixes</h2>
      <ul id="fixes"></ul>
    </article>

    <article class="card">
      <h2>Category summary</h2>
      <ul id="categories"></ul>
    </article>

    <article class="card">
      <a href="/tools/aio">Run your own checkup</a>
    </article>
  </section>

  <script>
    const params = new URLSearchParams(window.location.search);
    const sid = params.get("sid");

    const metaEl = document.getElementById("share-meta");
    const scoreEl = document.getElementById("score");
    const gradeEl = document.getElementById("grade");
    const confidenceEl = document.getElementById("confidence");
    const fixesEl = document.getElementById("fixes");
    const categoriesEl = document.getElementById("categories");

    function esc(value) {
      return String(value)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    async function load() {
      if (!sid) {
        metaEl.textContent = "Missing share id.";
        return;
      }

      const res = await fetch(`/api/ai-visibility-share.json?sid=${encodeURIComponent(sid)}`);
      const payload = await res.json();

      if (!res.ok) {
        metaEl.textContent = payload.message || "Share not found.";
        return;
      }

      const title = `AI Visibility Checkup: ${payload.grade} (${payload.score}/100)`;
      const description = "Top fixes included. Generated by AICV.";
      const canonical = `${window.location.origin}/tools/aio/r/share?sid=${encodeURIComponent(sid)}`;

      document.title = title;
      upsertMeta("description", description, false);
      upsertMeta("og:title", title, true);
      upsertMeta("og:description", description, true);
      upsertMeta("og:url", canonical, true);

      metaEl.textContent = payload.url;
      scoreEl.textContent = `${payload.score}/100`;
      gradeEl.textContent = payload.grade;
      confidenceEl.textContent = `Confidence: ${payload.confidence}`;

      fixesEl.innerHTML = (payload.topFixes || [])
        .map((fix) => `<li><strong>${esc(fix.title)}</strong>: ${esc(fix.how)}</li>`)
        .join("");

      categoriesEl.innerHTML = (payload.categories || [])
        .map((cat) => `<li>${esc(cat.name)}: ${cat.score}/${cat.max}</li>`)
        .join("");
    }

    function upsertMeta(name, content, isProperty) {
      const selector = isProperty ? `meta[property="${name}"]` : `meta[name="${name}"]`;
      let node = document.head.querySelector(selector);
      if (!node) {
        node = document.createElement("meta");
        if (isProperty) {
          node.setAttribute("property", name);
        } else {
          node.setAttribute("name", name);
        }
        document.head.appendChild(node);
      }
      node.setAttribute("content", content);
    }

    load().catch(() => {
      metaEl.textContent = "Could not load shared result.";
    });
  </script>
</BaseLayout>

<style>
  .share-wrap {
    display: grid;
    gap: 0.9rem;
  }

  .card {
    background: #fff;
    border: 1px solid #d7deea;
    border-radius: 10px;
    padding: 1rem;
  }

  .small {
    margin: 0;
    color: #52607a;
    font-size: 0.92rem;
  }

  .score {
    margin: 0.4rem 0 0.3rem;
    font-size: 2rem;
    font-weight: 700;
    color: #0f4eb1;
  }

  .pill {
    margin: 0;
    display: inline-block;
    background: #e8eefc;
    color: #1f3f8d;
    border-radius: 999px;
    padding: 0.23rem 0.6rem;
    font-weight: 600;
  }

  ul {
    margin: 0;
    padding-left: 1.2rem;
  }

  a {
    color: #1e4cb0;
    text-decoration: none;
    font-weight: 600;
  }

  a:hover,
  a:focus-visible {
    text-decoration: underline;
  }
</style>
