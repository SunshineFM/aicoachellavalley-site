---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import ActionCard from "../../components/ActionCard.astro";
import PageHero from "../../components/PageHero.astro";
import { CITY_ENTRIES, normalizeMeta } from "../../utils/briefs";

const briefs = await getCollection("signals");
const briefCountByCity = new Map<string, number>();
const liveCitySlugs = new Set(CITY_ENTRIES.map((city) => city.slug));

briefs.forEach((brief) => {
  const citySlug = normalizeMeta(brief.data.city);
  if (!citySlug) return;
  briefCountByCity.set(citySlug, (briefCountByCity.get(citySlug) ?? 0) + 1);
});

const cityListJsonLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  itemListElement: CITY_ENTRIES.map((city, index) => ({
    "@type": "ListItem",
    position: index + 1,
    url: `https://aicoachellavalley.com/cities/${city.slug}`,
    name: city.name,
  })),
};
---

<BaseLayout title="Cities | AI Coachella Valley">
  <script type="application/ld+json" set:html={JSON.stringify(cityListJsonLd)}></script>
  <PageHero title="All Cities" description="Explore city-level briefs across the Coachella Valley." />
  <section>
    <h2>City Brief Hubs</h2>
    <div class="city-grid">
    {CITY_ENTRIES.map((city) => {
      const count = briefCountByCity.get(city.slug) ?? 0;
      const isLive = liveCitySlugs.has(city.slug);
      return (
        <ActionCard
          title={city.name}
          description={`${count} brief${count === 1 ? "" : "s"} currently available`}
          href={isLive ? `/cities/${city.slug}` : undefined}
          buttonLabel={isLive ? `Open ${city.name}` : "Coming soon"}
          disabled={!isLive}
        />
      );
    })}
    </div>
  </section>
</BaseLayout>

<style>
  section + section {
    margin-top: var(--s-7);
  }

  .city-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(16rem, 1fr));
    gap: var(--s-4);
  }

  @media (max-width: 50rem) {
    .city-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
