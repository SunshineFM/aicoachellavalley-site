---
import ActionCard from "../../components/ActionCard.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import PageHero from "../../components/PageHero.astro";
import ResearchCoverage from "../../components/ResearchCoverage.astro";
import { CITIES } from "../../data/cities";
import { getCollection } from "astro:content";
import { loadCityResearch } from "../../utils/researchLoader";
import { normalizeMeta, resolveSummary } from "../../utils/briefs";

export function getStaticPaths() {
  return CITIES.map((city) => ({
    params: { city: city.slug },
  }));
}

const cityParam = (Astro.params.city || "").toLowerCase();
const city = CITIES.find((entry) => entry.slug === cityParam);

if (!city) {
  return new Response(null, { status: 404, statusText: "Not Found" });
}

const allBriefs = await getCollection("signals");
const research = await loadCityResearch({ citySlug: city.slug, year: 2025 });
const confirmedBriefs = allBriefs
  .filter((brief) => normalizeMeta(brief.data.city) === city.slug)
  .filter((brief) => Array.isArray(brief.data.sources) && brief.data.sources.length > 0)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const lastUpdated = research?.lastScanDate || city.stateOfAI?.lastUpdated || new Date().toISOString().slice(0, 10);
const coverage = research
  ? {
      meetingsScanned: research.coverage.meetingsScanned,
      transcriptsAvailable: research.coverage.transcriptsAvailable,
      documentsScanned: research.coverage.documentsScanned,
      aiMentionsFound: research.coverage.aiMentionsFound,
      lastScanDate: research.lastScanDate,
    }
  : city.stateOfAI?.coverage;
const watchCategories = [
  "Procurement",
  "Workforce",
  "Education",
  "Public Safety",
  "Privacy",
  "Economic Development",
];
const dateFormatter = new Intl.DateTimeFormat("en-US", {
  year: "numeric",
  month: "short",
  day: "2-digit",
});
---

<BaseLayout title={`${city.name} State of AI | AI Coachella Valley`}>
  <PageHero
    title={`State of AI in ${city.name}`}
    description="Baseline snapshot (public-source evidence)."
  />

  <section>
    <p class="meta-line"><strong>Last updated:</strong> {lastUpdated}</p>
  </section>

  <section>
    <h2>Confirmed signals</h2>
    {confirmedBriefs.length === 0 ? (
      <>
        <p>
          No confirmed public AI references yet. This page will update as sources are scanned and briefs are submitted.
        </p>
        <p><a class="btn btn-secondary" href="/submit">Submit a brief</a></p>
      </>
    ) : (
      <div class="signals-grid">
        {confirmedBriefs.map((brief) => (
          <article class="signal-card">
            <h3><a href={`/briefs/${brief.slug}`}>{brief.data.title}</a></h3>
            <p class="signal-meta">{dateFormatter.format(brief.data.date)}</p>
            <p>{resolveSummary(brief)}</p>
            <h4>Sources</h4>
            <ul class="source-list">
              {(brief.data.sources || []).map((source) => (
                typeof source === "string" ? (
                  <li><a href={source} target="_blank" rel="noreferrer">{source}</a></li>
                ) : (
                  <li>
                    <a href={source.url} target="_blank" rel="noreferrer">{source.label || source.url}</a>
                    {source.type ? ` (${source.type})` : ""}
                  </li>
                )
              ))}
            </ul>
          </article>
        ))}
      </div>
    )}
  </section>

  <section>
    <h2>Research Coverage</h2>
    <ResearchCoverage coverage={coverage} />
  </section>

  <section>
    <h2>Confirmed public-source hits (from research)</h2>
    {!research ? (
      <p>Research scan in progress. Coverage metrics will appear here once logged.</p>
    ) : research.hits.length === 0 ? (
      <p>No confirmed hits logged yet for this city/year.</p>
    ) : (
      <div class="hits-grid">
        {research.hits.map((hit) => (
          <article class="signal-card">
            <h3>{hit.title}</h3>
            <p class="signal-meta">
              {hit.date ? `Date: ${hit.date}` : "Date: Unknown"}
              {hit.timestampOrPage ? ` · Location: ${hit.timestampOrPage}` : ""}
              {` · Type: ${hit.sourceType}`}
            </p>
            <p>{hit.snippet}</p>
            <p><a href={hit.sourceUrl} target="_blank" rel="noreferrer">Open source</a></p>
          </article>
        ))}
      </div>
    )}
  </section>

  <section>
    <h2>What we're watching</h2>
    <p>These are the public-source categories we track for city AI signal.</p>
    <ul>
      {watchCategories.map((item) => (
        <li>{item}</li>
      ))}
    </ul>
  </section>

  <section>
    <h2>Top Paths</h2>
    <div class="path-grid">
      <ActionCard
        title={`Open ${city.name} city hub`}
        description="Return to the city intelligence page."
        href={`/cities/${city.slug}`}
        buttonLabel="Open City Hub"
      />
      <ActionCard
        title="View all briefs"
        description="Scan the evidence layer across all cities."
        href="/briefs"
        buttonLabel="Open Briefs"
      />
      <ActionCard
        title="Submit a brief"
        description="Contribute source-backed evidence for this city."
        href="/submit"
        buttonLabel="Open Submit a Brief"
      />
    </div>
  </section>
</BaseLayout>

<style>
  section + section {
    margin-top: var(--s-6);
  }

  ul {
    margin: 0;
    padding-left: 1.2rem;
    display: grid;
    gap: var(--s-2);
  }

  .meta-line {
    margin: 0;
    color: var(--c-muted);
  }

  .signals-grid,
  .hits-grid,
  .path-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(16rem, 1fr));
    gap: var(--s-4);
  }

  .signal-card {
    border: 1px solid var(--c-border);
    border-radius: var(--r-md);
    background: var(--c-surface);
    box-shadow: var(--shadow-1);
    padding: var(--s-5);
  }

  .signal-card h3 {
    margin: 0;
  }

  .signal-card h4 {
    margin-bottom: 0.45rem;
    font-size: 0.95rem;
  }

  .signal-meta {
    color: var(--c-muted);
    margin-bottom: var(--s-2);
  }

  .source-list {
    margin: 0;
    padding-left: 1.2rem;
  }
</style>
